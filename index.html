<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha RPG - Alta Fantasia</title>
    <style>
        :root { --bg: #1a1a1a; --card-bg: #41141a; --header-bg: #800000; --text: #ffffff; --input-bg: #2a0a0d; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; max-width: 1400px; width: 100%; }
        .col { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid #5a1a1f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .header-label { background: var(--header-bg); text-align: center; border-radius: 20px; padding: 5px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        input, textarea { background: var(--input-bg); border: 1px solid #555; color: white; padding: 8px; border-radius: 20px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        label { font-size: 10px; color: #ffaaaa; font-weight: bold; margin-left: 10px; text-transform: uppercase; display: block; }

        .avatar-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .avatar-circle { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--header-bg); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center; position: relative; }
        .avatar-circle input[type="file"] { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }

        .bar-container { margin-bottom: 10px; }
        .bar-controls { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5); border-radius: 25px; padding: 4px 8px; }
        .btn-math { background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; font-weight: bold; width: 30px; z-index: 10; }
        .bar-bg { flex-grow: 1; height: 28px; background: #222; border-radius: 15px; position: relative; overflow: hidden; border: 1px solid #444; display: flex; align-items: center; }
        .bar-fill { position: absolute; left: 0; top: 0; height: 100%; transition: width 0.3s ease; z-index: 1; width: 100%; }
        .hp-fill { background: #d32f2f; } .mp-fill { background: #1976d2; } .pa-fill { background: #7b1fa2; }
        .bar-values { position: relative; z-index: 5; width: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .bar-values input { pointer-events: auto; width: 45px; background: transparent; border: none; text-align: center; font-size: 14px; font-weight: bold; color: white; text-shadow: 1px 1px 2px #000; margin: 0; padding: 0; }

        .pericia-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); margin-bottom: 6px; padding: 8px 15px; border-radius: 20px; border: 1px solid #5a1a1f; cursor: pointer; transition: 0.2s; }
        .pericia-row span { font-size: 11px; font-weight: bold; text-transform: uppercase; pointer-events: none; }
        .pericia-row.treinado { background: #ffaaaa; color: #000; border-color: #fff; }
        .pericia-row.treinado span { color: #000; }

        .attr-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .attr-box { background: rgba(255,255,255,0.05); border: 1px solid #7a2a2f; border-radius: 12px; padding: 10px 2px; text-align: center; }
        .attr-box input { font-size: 28px; font-weight: bold; text-align: center; border: none; background: transparent; color: white; margin: 0; }
        .attr-box div { font-size: 9px; font-weight: bold; color: #ffaaaa; }

        .skull { opacity: 0.2; transition: 0.3s; cursor: pointer; font-size: 30px; margin: 0 5px; }
        .skull.active { opacity: 1; filter: drop-shadow(0 0 5px red); }
        .marker-item { cursor: pointer; font-size: 24px; opacity: 0.2; transition: 0.3s; filter: grayscale(1); }
        .marker-item.active { opacity: 1; filter: grayscale(0); drop-shadow: 0 0 5px currentColor; }
        .tri { color: #00ffff; } .circ { color: #00ff00; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="col">
        <div class="card">
            <div class="header-label">Personagem</div>
            <div class="avatar-container">
                <div class="avatar-circle" id="avatar_display"><input type="file" id="img_upload" accept="image/*"></div>
                <input type="text" id="char_name" placeholder="NOME">
            </div>
            <label>IDADE</label><input type="text" id="idade">
            <label>FLORINS</label><input type="text" id="florins">
            <label>ARQU√âTIPO</label><input type="text" id="arquetipo">
            
            <div class="header-label" style="margin-top:15px;">Status</div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('hp', -1)">-</button>
                    <div class="bar-bg"><div id="bar_hp" class="bar-fill hp-fill"></div><div class="bar-values"><input type="number" id="hp_at"> / <input type="number" id="hp_max"></div></div>
                    <button class="btn-math" onclick="changeVal('hp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('mp', -1)">-</button>
                    <div class="bar-bg"><div id="bar_mp" class="bar-fill mp-fill"></div><div class="bar-values"><input type="number" id="mp_at"> / <input type="number" id="mp_max"></div></div>
                    <button class="btn-math" onclick="changeVal('mp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('pa', -1)">-</button>
                    <div class="bar-bg"><div id="bar_pa" class="bar-fill pa-fill"></div><div class="bar-values"><input type="number" id="pa_at"> / <input type="number" id="pa_max"></div></div>
                    <button class="btn-math" onclick="changeVal('pa', 1)">+</button>
                </div>
            </div>
            <div style="text-align:center; margin: 10px 0;"><span class="skull" id="skull1" onclick="toggleSkull('skull1')">üíÄ</span><span class="skull" id="skull2" onclick="toggleSkull('skull2')">üíÄ</span><span class="skull" id="skull3" onclick="toggleSkull('skull3')">üíÄ</span></div>
            <div class="attr-container">
                <div class="attr-box"><input type="number" id="poder"><div>PODER</div></div>
                <div class="attr-box"><input type="number" id="habilidade"><div>HAB.</div></div>
                <div class="attr-box"><input type="number" id="resistencia"><div>RES.</div></div>
            </div>
            <div class="header-label">Per√≠cias</div>
            <div id="pericias-list">
                <div class="pericia-row" onclick="togglePericia(this, 'p_animais')"><span>ANIMAIS</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_arte')"><span>ARTE</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_esporte')"><span>ESPORTE</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_influencia')"><span>INFLU√äNCIA</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_luta')"><span>LUTA</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_manha')"><span>MANHA</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_maquinas')"><span>M√ÅQUINAS</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_medicina')"><span>MEDICINA</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_mistica')"><span>M√çSTICA</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_percepcao')"><span>PERCEP√á√ÉO</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_saber')"><span>SABER</span></div>
                <div class="pericia-row" onclick="togglePericia(this, 'p_sobrevivencia')"><span>SOBREVIV√äNCIA</span></div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card">
            <div class="header-label">Habilidades Gerais</div>
            <label>Vantagens / Desvantagens <button onclick="addItem('vantagens')">+</button></label><div id="list_vantagens"></div>
            <label>Arqu√©tipo <button onclick="addItem('arquetipo_hab')">+</button></label><div id="list_arquetipo_hab"></div>
            <label>Artefatos <button onclick="addItem('artefatos')">+</button></label><div id="list_artefatos"></div>
            <label>T√©cnicas <button onclick="addItem('tecnicas')">+</button></label><div id="list_tecnicas"></div>
        </div>
    </div>
    <div class="col">
        <div class="card">
            <div class="header-label">A√ß√µes e Deslocamento</div>
            <label>A√á√ïES</label><div class="bar-controls"><button onclick="updateMarkerCount('a√ß√µes', -1)">-</button><span id="count_a√ß√µes">0</span><button onclick="updateMarkerCount('a√ß√µes', 1)">+</button></div><div id="display_a√ß√µes"></div>
            <label>DESLOCAMENTO</label><div class="bar-controls"><button onclick="updateMarkerCount('desloc', -1)">-</button><span id="count_desloc">0</span><button onclick="updateMarkerCount('desloc', 1)">+</button></div><div id="display_desloc"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, update, onValue, remove, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const fichaID = urlParams.get('p') || "personagem_padrao";
    const fichaRef = ref(db, 'fichas/' + fichaID);

    // FUN√á√ÉO UNIVERSAL DE SALVAMENTO COM DEBOUNCE
    let timeout = null;
    function autoSave(data) {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            update(fichaRef, data).catch(err => console.error("Erro ao salvar:", err));
        }, 500);
    }

    document.addEventListener('input', (e) => {
        if (e.target.id) {
            const data = { [e.target.id]: e.target.value };
            autoSave(data);
            const base = e.target.id.split('_')[0];
            if (['hp', 'mp', 'pa'].includes(base)) updateBarVisual(base);
        }
    });

    onValue(fichaRef, (snapshot) => {
        const dados = snapshot.val();
        if (!dados) return;
        Object.keys(dados).forEach(id => {
            const el = document.getElementById(id);
            if (id === 'char_img') document.getElementById('avatar_display').style.backgroundImage = `url(${dados[id]})`;
            else if (id === 'pericias') {
                Object.keys(dados.pericias).forEach(p => {
                    const row = document.querySelector(`[onclick*="${p}"]`);
                    if(row) dados.pericias[p] ? row.classList.add('treinado') : row.classList.remove('treinado');
                });
            } else if (id === 'habilidades') {
                Object.keys(dados.habilidades).forEach(cat => renderHabs(cat, dados.habilidades[cat]));
            } else if (id === 'marcadores') {
                renderMarkers('a√ß√µes', dados.marcadores['a√ß√µes']?.total, dados.marcadores['a√ß√µes']?.pontos);
                renderMarkers('desloc', dados.marcadores['desloc']?.total, dados.marcadores['desloc']?.pontos);
            } else if (el && document.activeElement !== el) {
                el.value = dados[id];
                const base = id.split('_')[0];
                if (['hp', 'mp', 'pa'].includes(base)) updateBarVisual(base);
            }
        });
    });

    function updateBarVisual(type) {
        const at = parseInt(document.getElementById(type + '_at').value) || 0;
        const max = parseInt(document.getElementById(type + '_max').value) || 1;
        const percent = Math.min(Math.max((at / max) * 100, 0), 100);
        const el = document.getElementById('bar_' + type);
        if (el) el.style.width = percent + '%';
    }

    window.togglePericia = (el, id) => {
        const isTreinado = el.classList.toggle('treinado');
        update(ref(db, `fichas/${fichaID}/pericias`), { [id]: isTreinado });
    };

    window.changeVal = (type, mod) => {
        const el = document.getElementById(type + '_at');
        const newVal = (parseInt(el.value) || 0) + mod;
        el.value = newVal;
        update(fichaRef, { [type + '_at']: newVal });
        updateBarVisual(type);
    };

    window.toggleSkull = (id) => {
        const el = document.getElementById(id);
        const active = el.classList.toggle('active');
        update(fichaRef, { [id]: active ? "active" : "inactive" });
    };

    window.updateMarkerCount = (type, mod) => {
        const current = parseInt(document.getElementById('count_'+type).innerText) || 0;
        update(ref(db, `fichas/${fichaID}/marcadores/${type}`), { total: Math.max(0, current + mod) });
    };

    function renderMarkers(type, total, pontos) {
        const container = document.getElementById('display_'+type);
        document.getElementById('count_'+type).innerText = total || 0;
        container.innerHTML = "";
        for(let i=0; i < (total || 0); i++) {
            const active = pontos && pontos[`p_${i}`] ? 'active' : '';
            const span = document.createElement('span');
            span.className = `marker-item ${type==='a√ß√µes'?'tri':'circ'} ${active}`;
            span.innerHTML = type==='a√ß√µes'?'‚ñ≤':'‚óè';
            span.onclick = () => update(ref(db, `fichas/${fichaID}/marcadores/${type}/pontos`), { [`p_${i}`]: !active });
            container.appendChild(span);
        }
    }

    window.addItem = (category) => set(push(ref(db, `fichas/${fichaID}/habilidades/${category}`)), { titulo: "Nova", teste: "", desc: "" });
    function renderHabs(cat, data) {
        const container = document.getElementById('list_'+cat);
        if(!container) return; container.innerHTML = "";
        Object.keys(data || {}).forEach(id => {
            const item = data[id];
            const div = document.createElement('div');
            div.className = 'hab-item';
            div.innerHTML = `<div class="hab-header"><span onclick="this.parentElement.nextElementSibling.classList.toggle('open')">‚ñº</span><input value="${item.titulo}" oninput="updateHab('${cat}','${id}','titulo',this.value)"><input value="${item.teste}" oninput="updateHab('${cat}','${id}','teste',this.value)"><button onclick="removeHab('${cat}','${id}')">‚úñ</button></div><div class="hab-body"><textarea oninput="updateHab('${cat}','${id}','desc',this.value)">${item.desc}</textarea></div>`;
            container.appendChild(div);
        });
    }
    window.updateHab = (cat, id, f, v) => update(ref(db, `fichas/${fichaID}/habilidades/${cat}/${id}`), { [f]: v });
    window.removeHab = (cat, id) => confirm("Apagar?") && remove(ref(db, `fichas/${fichaID}/habilidades/${cat}/${id}`));

    document.getElementById('img_upload').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = () => update(fichaRef, { char_img: reader.result });
        reader.readAsDataURL(e.target.files[0]);
    });
</script>
</body>
</html>

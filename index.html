<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha RPG - Alta Fantasia</title>
    <style>
        :root { --bg: #1a1a1a; --card-bg: #41141a; --header-bg: #800000; --text: #ffffff; --input-bg: #2a0a0d; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; max-width: 1400px; width: 100%; }
        .col { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid #5a1a1f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .header-label { background: var(--header-bg); text-align: center; border-radius: 20px; padding: 5px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; display: flex; justify-content: center; align-items: center; gap: 10px; }
        input, textarea { background: var(--input-bg); border: 1px solid #555; color: white; padding: 8px; border-radius: 20px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        label { font-size: 10px; color: #ffaaaa; font-weight: bold; margin-left: 10px; text-transform: uppercase; display: block; }
        .avatar-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .avatar-circle { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--header-bg); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center; position: relative; }
        .avatar-circle input[type="file"] { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }
        .bar-container { margin-bottom: 10px; }
        .bar-controls { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5); border-radius: 25px; padding: 4px 8px; }
        .btn-math { background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; font-weight: bold; width: 30px; }
        .bar-bg { flex-grow: 1; height: 28px; background: #222; border-radius: 15px; position: relative; overflow: hidden; border: 1px solid #444; display: flex; align-items: center; }
        .bar-fill { position: absolute; left: 0; top: 0; height: 100%; transition: width 0.3s ease; width: 100%; }
        .hp-fill { background: #d32f2f; } .mp-fill { background: #1976d2; } .pa-fill { background: #7b1fa2; }
        .bar-values { position: relative; z-index: 5; width: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .bar-values input { pointer-events: auto; width: 45px; background: transparent; border: none; text-align: center; font-size: 14px; font-weight: bold; color: white; text-shadow: 1px 1px 2px #000; margin: 0; }
        .attr-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .attr-box { background: rgba(255,255,255,0.05); border: 1px solid #7a2a2f; border-radius: 12px; padding: 10px 2px; text-align: center; }
        .attr-box input { font-size: 28px; font-weight: bold; text-align: center; border: none; background: transparent; color: white; }
        .pericia-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); margin-bottom: 4px; padding: 5px 15px; border-radius: 20px; border: 1px solid #5a1a1f; }
        .skull { opacity: 0.2; transition: 0.3s; cursor: pointer; font-size: 30px; margin: 0 5px; }
        .skull.active { opacity: 1; filter: drop-shadow(0 0 5px red); }
        .hab-item { background: rgba(0,0,0,0.3); border: 1px solid #5a1a1f; border-radius: 10px; margin-bottom: 8px; overflow: hidden; }
        .hab-header { display: flex; align-items: center; padding: 8px; gap: 5px; }
        .hab-body { padding: 8px; display: none; border-top: 1px solid #5a1a1f; }
        .hab-body.open { display: block; }
        .btn-add { background: #22aa22; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="col">
        <div class="card">
            <div class="header-label">Personagem</div>
            <div class="avatar-container">
                <div class="avatar-circle" id="avatar_display">
                    <input type="file" id="img_upload" accept="image/*">
                </div>
                <input type="text" id="char_name" style="background:transparent; border:none; text-align:center; font-size:18px; font-weight:bold; margin-top:10px; color:white;" placeholder="NOME" oninput="salvarDireto('char_name', this.value)">
            </div>
            <label>IDADE</label><input type="text" id="idade" oninput="salvarDireto('idade', this.value)">
            <label>FLORINS</label><input type="text" id="florins" oninput="salvarDireto('florins', this.value)">
            <label>ARQU√âTIPO</label><input type="text" id="arquetipo" oninput="salvarDireto('arquetipo', this.value)">
            
            <div class="header-label" style="margin-top:15px;">Status</div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="ajustar('hp', -1)">-</button>
                    <div class="bar-bg"><div id="fill_hp" class="bar-fill hp-fill"></div><div class="bar-values"><input type="number" id="hp_at" oninput="salvarStatus('hp')"> / <input type="number" id="hp_max" oninput="salvarStatus('hp')"></div></div>
                    <button class="btn-math" onclick="ajustar('hp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="ajustar('mp', -1)">-</button>
                    <div class="bar-bg"><div id="fill_mp" class="bar-fill mp-fill"></div><div class="bar-values"><input type="number" id="mp_at" oninput="salvarStatus('mp')"> / <input type="number" id="mp_max" oninput="salvarStatus('mp')"></div></div>
                    <button class="btn-math" onclick="ajustar('mp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="ajustar('pa', -1)">-</button>
                    <div class="bar-bg"><div id="fill_pa" class="bar-fill pa-fill"></div><div class="bar-values"><input type="number" id="pa_at" oninput="salvarStatus('pa')"> / <input type="number" id="pa_max" oninput="salvarStatus('pa')"></div></div>
                    <button class="btn-math" onclick="ajustar('pa', 1)">+</button>
                </div>
            </div>

            <div style="text-align:center; margin: 10px 0;"><span class="skull" id="skull1" onclick="toggleSkull('skull1')">üíÄ</span><span class="skull" id="skull2" onclick="toggleSkull('skull2')">üíÄ</span><span class="skull" id="skull3" onclick="toggleSkull('skull3')">üíÄ</span></div>
            
            <div class="attr-container">
                <div class="attr-box"><input type="number" id="poder" oninput="salvarAtributo('poder')"><div>PODER</div></div>
                <div class="attr-box"><input type="number" id="habilidade" oninput="salvarAtributo('habilidade')"><div>HAB.</div></div>
                <div class="attr-box"><input type="number" id="resistencia" oninput="salvarAtributo('resistencia')"><div>RES.</div></div>
            </div>

            <div class="header-label">Per√≠cias</div>
            <div id="pericias_list">
                <div class="pericia-row"><span>LUTA</span><input type="number" id="p_luta" value="0" oninput="salvarDireto('p_luta', this.value)"></div>
                <div class="pericia-row"><span>M√çSTICA</span><input type="number" id="p_mistica" value="0" oninput="salvarDireto('p_mistica', this.value)"></div>
                </div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <div class="header-label">Habilidades Gerais</div>
            <label>Vantagens <button class="btn-add" onclick="addItem('vantagens')">+</button></label>
            <div id="list_vantagens"></div>
            <label>T√©cnicas <button class="btn-add" onclick="addItem('tecnicas')">+</button></label>
            <div id="list_tecnicas"></div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <div class="header-label">A√ß√µes / Deslocamento</div>
            <div id="marcadores_area"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, update, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const fichaID = urlParams.get('p') || "personagem_padrao";

    // --- SALVAMENTO ISOLADO (ESTABILIDADE) ---
    window.salvarStatus = (tipo) => {
        update(ref(db, `fichas/${fichaID}/status/${tipo}`), {
            at: document.getElementById(`${tipo}_at`).value,
            max: document.getElementById(`${tipo}_max`).value
        });
    };

    window.salvarAtributo = (id) => {
        update(ref(db, `fichas/${fichaID}/atributos`), { [id]: document.getElementById(id).value });
    };

    window.salvarDireto = (caminho, valor) => {
        update(ref(db, `fichas/${fichaID}/geral`), { [caminho]: valor });
    };

    window.ajustar = (tipo, mod) => {
        const el = document.getElementById(`${tipo}_at`);
        let nv = (parseInt(el.value) || 0) + mod;
        const max = parseInt(document.getElementById(`${tipo}_max`).value) || 1;
        if(nv < 0) nv = 0; if(nv > max) nv = max;
        el.value = nv;
        window.salvarStatus(tipo);
    };

    function atualizarBarra(tipo, at, max) {
        const p = Math.min(Math.max((at / max) * 100, 0), 100);
        const el = document.getElementById(`fill_${tipo}`);
        if(el) el.style.width = p + "%";
    }

    // --- CARREGAMENTO ---
    onValue(ref(db, `fichas/${fichaID}`), (snap) => {
        const d = snap.val(); if(!d) return;

        if(d.status) Object.keys(d.status).forEach(t => {
            const atEl = document.getElementById(`${t}_at`), maxEl = document.getElementById(`${t}_max`);
            if(document.activeElement !== atEl) atEl.value = d.status[t].at || 0;
            if(document.activeElement !== maxEl) maxEl.value = d.status[t].max || 0;
            atualizarBarra(t, d.status[t].at, d.status[t].max);
        });

        if(d.atributos) Object.keys(d.atributos).forEach(a => {
            const el = document.getElementById(a);
            if(el && document.activeElement !== el) el.value = d.atributos[a] || 0;
        });

        if(d.geral) Object.keys(d.geral).forEach(g => {
            const el = document.getElementById(g);
            if(el && document.activeElement !== el) el.value = d.geral[g] || "";
        });
        
        // Reintegra√ß√£o de Avatar
        if(d.geral?.char_img) document.getElementById('avatar_display').style.backgroundImage = `url(${d.geral.char_img})`;
    });

    // --- L√ìGICA DE HABILIDADES GERAIS (MANTIDA) ---
    window.addItem = (cat) => {
        const refNew = push(ref(db, `fichas/${fichaID}/habilidades/${cat}`));
        set(refNew, { t: "Nova", d: "" });
    };

    // ... (Demais fun√ß√µes de renderiza√ß√£o de listas e marcadores permanecem as mesmas)
</script>
</body>
</html>

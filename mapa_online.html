<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Mundi - RPG</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        
        /* UI DO EDITOR */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 320px; height: 100%;
            background: rgba(30, 30, 30, 0.95); border-right: 2px solid #444;
            padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 8px;
            z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        body.viewer-mode #ui-layer { transform: translateX(-350px); }

        canvas { display: block; background: #111; cursor: default; }
        
        h2 { margin: 5px 0 5px 0; color: #ffaa00; text-transform: uppercase; font-size: 14px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; margin-top: 5px; }
        input[type="range"], input[type="text"], input[type="color"] { width: 100%; box-sizing: border-box; margin-bottom: 5px; background: #222; border: 1px solid #555; color: white; padding: 4px; border-radius: 4px; }
        
        .btn { background: #444; color: white; border: 1px solid #666; padding: 8px; cursor: pointer; width: 100%; margin-bottom: 5px; font-weight: bold; border-radius: 4px; transition: 0.2s; font-size: 12px; }
        .btn:hover { background: #666; }
        .btn-save { background: #2e7d32; border-color: #4caf50; }
        
        .tools-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .tool-btn { flex: 1; padding: 10px; font-size: 18px; background: #222; border: 1px solid #555; cursor: pointer; border-radius: 5px; }
        .tool-btn.active { background: #ffaa00; border-color: white; color: black; }

        .palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .swatch { width: 100%; aspect-ratio: 1; border: 2px solid #555; cursor: pointer; transition: 0.2s; position: relative; border-radius: 4px; display:flex; align-items:center; justify-content:center; background: #222; }
        .swatch:hover { border-color: white; transform: scale(1.1); z-index: 2; }
        .swatch.selected { border-color: #ffaa00; box-shadow: 0 0 10px #ffaa00; z-index: 2; }
        
        .status-led { width: 10px; height: 10px; border-radius: 50%; background: #444; display: inline-block; margin-right: 5px; }
        .status-led.on { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-led.busy { background: #ffaa00; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; pointer-events: none; opacity: 0; transition: 0.5s; }
        .loading-overlay.active { opacity: 1; pointer-events: all; }

        #viewer-msg { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid #ffaa00; color: #ffaa00; font-weight: bold; display: none; z-index: 5; }
        body.viewer-mode #viewer-msg { display: block; }
        
        .input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .input-group input { margin-bottom: 0; }
        .input-group button { width: 40px; margin-bottom: 0; display: flex; align-items: center; justify-content: center; }

        /* Controles de Fronteira (Escondidos por padr√£o) */
        #border-controls { display: none; background: #222; padding: 10px; border-radius: 5px; border: 1px solid #555; margin-bottom: 10px; }
        #border-controls.visible { display: block; }
    </style>
</head>
<body>

    <div id="viewer-msg">MODO VISUALIZADOR (Somente Leitura)</div>
    <div class="loading-overlay" id="loader">Carregando Mapa...</div>

    <div id="ui-layer">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>EDITOR DE MAPA</h2>
            <div title="Status da Conex√£o"><span id="db-led" class="status-led"></span></div>
        </div>

        <div class="tools-row">
            <button class="tool-btn active" id="btnBrush" onclick="setTool('brush')" title="Pintar Terreno (B)">üñåÔ∏è</button>
            <button class="tool-btn" id="btnBorder" onclick="setTool('border')" title="Desenhar Fronteira (F)">‚úèÔ∏è</button>
            <button class="tool-btn" id="btnHand" onclick="setTool('hand')" title="Mover (H / Espa√ßo)">‚úã</button>
        </div>

        <div id="border-controls">
            <label style="margin-top:0">Cor da Linha</label>
            <input type="color" id="borderColor" value="#ff0000">
            <label>Espessura</label>
            <input type="range" id="borderWidth" min="2" max="10" value="4">
            <small style="color:#aaa; font-size:10px;">Clique nas bordas dos hex√°gonos para desenhar.</small>
        </div>

        <h2>Configura√ß√£o Global</h2>
        <label>URL da Imagem de Fundo</label>
        <div class="input-group">
            <input type="text" id="bgUrlInput" placeholder="Link direto (Discord/Imgur)...">
            <button class="btn" onclick="updateBgFromUrl(document.getElementById('bgUrlInput').value)" title="Carregar">OK</button>
        </div>

        <label>Tamanho Hex√°gono</label>
        <input type="range" id="hexSize" min="10" max="150" value="30">
        <label>Opacidade Grade</label>
        <input type="range" id="gridOpacity" min="0" max="1" step="0.1" value="0.3">

        <hr style="border:0; border-top:1px solid #444; width:100%;">
        
        <h2>Terrenos</h2>
        <div class="palette" id="palette"></div>

        <button class="btn btn-save" onclick="saveToCloud()">‚òÅÔ∏è SALVAR NO CLOUD</button>
        <button class="btn" style="background:#c62828;" onclick="clearHexes()">üóëÔ∏è Limpar Tudo</button>
        
        <div style="margin-top:auto; font-size:11px; color:#666; text-align:center;">
            Link Visualizador:<br>
            <a href="#" id="viewLink" style="color:#4fc3f7; word-break:break-all;" target="_blank">...</a>
        </div>
    </div>

    <canvas id="mapCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const MODE = urlParams.get('mode') === 'view' ? 'VIEW' : 'EDIT';
    const MAP_ID = 'mapa_mundi_principal';

    if (MODE === 'VIEW') document.body.classList.add('viewer-mode');
    else {
        const baseUrl = window.location.href.split('?')[0];
        document.getElementById('viewLink').href = `${baseUrl}?mode=view`;
        document.getElementById('viewLink').innerText = "Clique para abrir modo Visualizador";
    }

    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const led = document.getElementById('db-led');

    let camera = { x: 0, y: 0, zoom:
